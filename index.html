<html>
	<head>
		<title>Farley Thesis</title>
		<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">	
	
	<style>
		#map{
			height: 80%;
		}
		html, body{
			height: 100%;
			overflow: hidden;
		}
		.graticule {
		  fill: none;
		  stroke: #777;
		  stroke-opacity: .5;
		  stroke-width: .5px;
		}
	#main{
		height: 80%;
		padding: 0px;
		margin: 0px;
	}
	#controls{
		height: 5%;
	}
	#timeline{
		height: 10%;
	}
	#nv{
		height: 80%;
	}
.land {
  fill: #222;
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
  z-index:1000;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}

	</style>
	</head>
	<body>
		<h3>Niche Viewer Early Prototyping</h3>
		<div id='controls' class='row'>
			<div id='map-controls' class='col-xs-6'>
				<h4>Map Controls</h4>
				<label>
					Set Reference Time Period
				</label><br />
				<label>Period Start: </label><input type='number' min="-30" max="22000" value='-30' step="100" id='min-year'><label>Years B.P.</label><br />
				<label>Period End: </label><input type='number' min="-30" max="22000" value='0' step="100" id='max-year'><label>Years B.P.</label>
			</div>
			<div id='chart-controls' class='col-xs-6'>
				<h4>Chart Controls</h4>
				<div class='col-xs-4'>
					<label>X-Axis Variable</label><select id='xVarSelect' class='axis-select'></select><br />
					<label>Y-Axis Variable</label><select id='yVarSelect' class='axis-select'></select><br />
					<label><button id='plot'>Plot</button></label><br />
				</div>
				<div class='col-xs-4'>
					<label>Display: </label><br />
					<label>Points</label><input type='radio' value='points' id='display-points-select' class='display-type'  name='display-select' checked> <br />
					<label>Hexbins</label><input type='radio' value='hexes' id='display-hexes-select' class='display-type' name='display-select'><br />
				</div>
				<div class='col-xs-4'>
					<div id='point-radius-holder'>
						<label>Point Radius: </label><input id='point-radius' type='range' min='1' max='25' step='1' value='5'>
					</div>
					<div id='hex-radius-holder'>
						<label>Hexagon Radius: </label><input id='hex-radius' type='range' min='1' max='100' step='1' value='10'>
					</div>
					
				</div>
				
				<label id='wait'>Loading data...</label>
			</div>
		</div>
		<div id='main' class='row'>
			<div id='map' class='col-xs-6'></div>
			<div id='nv' class='col-xs-6'></div>
		</div>
	<div id='timeline' class='row'>
		
	</div>
		
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> <!--Tooltips-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src='assets/js/hexbin.js'></script>
<script>

//change the stacking order of d3 elements
// https://github.com/wbkd/d3-extended
d3.selection.prototype.moveToFront = function() {  
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};
d3.selection.prototype.moveToBack = function() {  
    return this.each(function() { 
        var firstChild = this.parentNode.firstChild; 
        if (firstChild) { 
            this.parentNode.insertBefore(this, firstChild); 
        } 
    });
};

var zoom = d3.behavior.zoom()
    .translate([0, 0])
    .scale(1)
    .scaleExtent([1, 21])
    .on("zoom", zoomed);

function zoomed() {
	d3.selectAll(".land").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	d3.selectAll(".boundary").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	d3.selectAll(".map-point").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	d3.selectAll(".graticule").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
};
	

globals = {}
globals.map = {}
globals.chart = {}
globals.timeline = {}
globals.displayType = "points"


$("#hex-radius-holder").hide();

$(".display-type").change(function(){
	globals.displayType = $(this).val();
	if (globals.displayType == "points"){
		$("#point-radius-holder").show()
		$("#hex-radius-holder").hide()
		drawChartPoints(globals.chart.xVar, globals.chart.yVar, globals.data);
		
	}
	else if (globals.displayType == "hexes"){
		$("#point-radius-holder").hide()
		$("#hex-radius-holder").show()
		drawChartHexes(globals.chart.xVar, globals.chart.yVar, globals.data, $("#hex-radius").val());
	}
});

$(document).ready(function(){
	setupNVChart(); //set up the niche viewer chart
	loadBasemap(); // set up the map and load the basemap json file
	loadData("assets/data/sequoia_with_climate.csv"); //load the space/time/climate data --> calls the functions to draw map and chart points
});

function loadBasemap(){
	//set the projection parameters
	globals.map.width = $("#map").width();
	globals.map.height = $("#map").height();
	
	globals.map.projection = d3.geo.mercator()
	    .scale((globals.map.width + 1) / 2 / Math.PI)
	    .translate([globals.map.width / 2, globals.map.height / 2])
	    .precision(.1);
	
	globals.map.path = d3.geo.path()
	    .projection(globals.map.projection);
	
	globals.map.graticule = d3.geo.graticule();
	
	$("#map").empty();
	//draw the svg canvas
	globals.map.svg = d3.select("#map").append("svg")
	    .attr("width", globals.map.width)
	    .attr("height", globals.map.height);
	
	globals.map.svg.call(zoom).call(zoom.event)
	
	globals.map.svg.append("path")
	    .datum(globals.map.graticule)
	    .attr("class", "graticule")
	    .attr("d", globals.map.path);
	
	d3.json("assets/data/world-50m.json", function(error, world){
			globals.map.svg.insert("path", ".graticule")
	      .datum(topojson.feature(world, world.objects.land))
	      .attr("class", "land")
	      .attr("d", globals.map.path);
	
	  globals.map.svg.insert("path", ".graticule")
	      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
	      .attr("class", "boundary")
	      .attr("d", globals.map.path);
	});
}

function loadData(path){
	d3.csv(path, function(error, data){
		if (error){
			console.log(error);
			return;
		}
		globals.data = data;
		console.log("Data loaded successfully.");
		
		//set up the chart controls
		$(".axis-select").empty();
		var keys= _.keys(globals.data[2]);
		for (var i=0; i< keys.length; i++){
			key = keys[i];
			if ((key != "siteName") && (key != 'projected') &&(key != 'latitude') && (key != 'longitude') &&(key != 'pollenSum')){
				$(".axis-select").append("<option>" + keys[i] + "</option>");
			}
		}
		//convert to numeric
		_.each(globals.data, function(d){
			for (item in d){
				if (item != 'siteName'){
					d[item] = +d[item];
				}
			}
			d['projected'] = globals.map.projection([d.longitude, d.latitude]);
		});
		console.log(globals.data);
		drawMapPoints(globals.data); //draw the points on the geographic map
		setupTimeline(data);
		$("#wait").text("Platform loaded.")
		
		//enable event listener on opt select
		$("#plot").click(function(){
			$("#wait").text("Plotting niche view.  Please wait....")
			globals.chart.xVar = $("#xVarSelect option:selected").text();
			globals.chart.yVar = $("#yVarSelect option:selected").text();

			drawChartAxes(globals.chart.xVar, globals.chart.yVar, globals.data)
			if (globals.displayType == "points"){
				drawChartPoints(globals.chart.xVar, globals.chart.yVar, globals.data);
			}else{
				drawChartHexes(globals.chart.xVar, globals.chart.yVar, globals.data, 10);
			}
			stylePointsByAgeRange(-30, 0);
			
		});
	});
	
}

function setupNVChart(){
	globals.chart.margin = {top: 20, right: 50, bottom: 30, left: 60};
    globals.chart.width = $("#nv").width() - globals.chart.margin.left - globals.chart.margin.right;
    globals.chart.height = $("#nv").height() - globals.chart.margin.top - globals.chart.margin.bottom;
    
    
    globals.chart.x = d3.scale.linear()
	    .range([0, globals.chart.width]);
	
	globals.chart.y = d3.scale.linear()
	    .range([globals.chart.height, 0]);
	
	
	globals.chart.xAxis = d3.svg.axis()
	    .scale(globals.chart.x)
	    .orient("bottom");
	
	globals.chart.yAxis = d3.svg.axis()
	    .scale(globals.chart.y)
	    .orient("left");
	
	globals.chart.svg = d3.select("#nv").append("svg")
	    .attr("width", globals.chart.width + globals.chart.margin.left + globals.chart.margin.right)
	    .attr("height", globals.chart.height + globals.chart.margin.top + globals.chart.margin.bottom)
	  .append("g")
	    .attr("transform", "translate(" + globals.chart.margin.left + "," + globals.chart.margin.top + ")");
	

}

function drawMapPoints(data){
	//draws circles on the map at thr right latitude and longitude
	globals.map.svg.selectAll('.point')
		.data(data)
		.enter()
		.append("circle")
			.attr('class', function(d) { return "point map-point " + removeNonLetters(d.siteName) + "_" + d.age})
			.attr('cx', function(d){ 
				return d.projected[0]})
			.attr('cy', function(d){
				return d.projected[1]})
			.attr('r', 5)
			.attr('fill', 'blue')
			.attr('opacity', 0.25)
			.attr('stroke', 'black')
			.attr('stroke-opacity', 0.25).moveToFront()
			.on('mouseover', function(d){
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	highlight(c)
      }).on('mouseout', function(d){
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	deHighlight(c)
      });
	console.log("Draw map points complete.");
};

function drawChartHexes(xVar, yVar, data, radius){
	d3.select("#nv").selectAll(".hexagon").remove();
	d3.select("#nv").selectAll(".hexagons").remove();
	d3.select("#nv").selectAll(".point").remove();
	
	
	globals.chart.hexbin = d3.hexbin()
    .size([globals.chart.width, globals.chart.height])
    .radius(radius);
	globals.chart.hexbin.x(function(d){
		if (d[xVar]){
			return globals.chart.x(d[xVar]);
		}
		
	});
	globals.chart.hexbin.y(function(d){
		if (d[yVar]){
			return globals.chart.y(d[yVar]);
		}
	});
	
	
	globals.chart.color = d3.scale.linear()
    .domain([0, 1000])
    .range(["navajowhite", "steelblue"])
    .interpolate(d3.interpolateLab);
	
	globals.chart.hexagons = globals.chart.svg.append("g")
	      .attr("class", "hexagons")
	    .selectAll(".hexagon")
	      .data(globals.chart.hexbin(data))
	    .enter().append("path")
	    	.attr('class', 'hexagon')
	      .attr("d", globals.chart.hexbin.hexagon())
	      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
	      .style('stroke-width', 0.25)
	      .on('click', function(d){
	      	console.log(d);
	      })
	      .on('mouseover', function(d){
	      	d3.select(this).transition().attr('stroke', 'orange').style('stroke-width', 2.5)
	      	
	      	for (item in d){
	      		if (typeof d[item] == "object"){
	      			c = "." + removeNonLetters(d[item].siteName) + "_" + d[item].age
	      			highlight(c)
	      		}
	      	}
	      })
	      .on('mouseout', function(d){
	      	d3.select(this).transition().attr('stroke', 'none').style('stroke-width', 0)
	      	for (item in d){
	      		if (typeof d[item] == "object"){
	      			c = "." + removeNonLetters(d[item].siteName) + "_" + d[item].age
	      			deHighlight(c)
	      		}
	      	}
	      });
	styleHexagons()
	 $("#wait").text("Ready.");
	
}

function styleHexagons(){
	hexes = d3.selectAll(".hexagon")[0]
	console.log(hexes)
	r = d3.extent(hexes, function(d){ 
		return d.__data__.length})
	console.log(r)
	globals.chart.color = d3.scale.linear()
    .domain(r)
    .range(["#d3e2ef", "#2a2337"])
    .interpolate(d3.interpolateLab);
    
    d3.selectAll(".hexagon").attr('fill', function(d){
    	return globals.chart.color(d.length)
    });
}

function drawChartAxes(xVar, yVar, data){
	d3.select("#nv").selectAll(".axis").remove()
	d3.select("#nv").selectAll(".label").remove()
	d3.select("#nv").selectAll(".point").remove()
	d3.select("#nv").selectAll(".hexagon").remove()
	d3.select("#nv").selectAll(".hexagons").remove()
	
	//calculate min/max from the data
	globals.chart.x.domain(d3.extent(data, function(d){return d[xVar]}));
	globals.chart.y.domain(d3.extent(data, function(d){return d[yVar]}));

	
	globals.chart.svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + globals.chart.height + ")")
      .call(globals.chart.xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", globals.chart.width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text(xVar);

  globals.chart.svg.append("g")
      .attr("class", "y axis")
      .call(globals.chart.yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text(yVar);
}

function drawChartPoints(xVar, yVar, data){
		d3.select("#nv").selectAll(".hexagon").remove();
	d3.select("#nv").selectAll(".hexagons").remove();
	d3.select("#nv").selectAll(".point").remove();

  globals.chart.svg.selectAll(".point")
      .data(data)
    .enter().append("circle")
      .attr('class', function(d) { return "point chart-point " + removeNonLetters(d.siteName) + "_" + d.age})
      .attr("r", 3.5)
      .attr("cx", function(d) {  
      	val = globals.chart.x(d[xVar]);
      	if ((val) && (val != NaN)){
      		return val;
      	}else{
      		return 0;
      	} })
        .attr("cy", function(d) {  
	      	val = globals.chart.y(d[yVar]);
	      	if ((val) && (val != NaN)){
	      		return val;
	      	}else{
	      		return 0;
      	} })
      	.attr('fill', 'blue').on('mouseover', function(d){
      		console.log(d)
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	highlight(c)
      }).on('mouseout', function(d){
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	deHighlight(c)
      });
	      	
	  
	 refMinAge = $("#min-year").val();
	 refMaxAge = $("#max-year").val();
	 
	 stylePointsByAgeRange(refMinAge, refMaxAge)
     
     $("#wait").text("Ready.")
}

function setupTimeline(data){
	d3.select("#timeline").empty();
	
	globals.timeline.margin = {top: 10, right: 30, bottom: 30, left: 30};
    globals.timeline.width = $("#timeline").width() - globals.timeline.margin.left - globals.timeline.margin.right;
    globals.timeline.height = $("#timeline").height() - globals.timeline.margin.top - globals.timeline.margin.bottom;
    
    ages = _.pluck(data, "age");
    console.log(ages);
    
    
    globals.timeline.x = d3.scale.linear()
    .domain(d3.extent(data, function(d){return d.age;}))
    .range([0, globals.timeline.width]);
    
    globals.timeline.xAxis = d3.svg.axis()
    .scale(globals.timeline.x)
    .orient("bottom");
    
    globals.timeline.svg = d3.select("#timeline").append("svg")
    .attr("width", globals.timeline.width + globals.timeline.margin.left + globals.timeline.margin.right)
    .attr("height", globals.timeline.height + globals.timeline.margin.top + globals.timeline.margin.bottom)
  .append("g")
    .attr("transform", "translate(" + globals.timeline.margin.left + ",-6)");
    
    globals.timeline.svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + globals.timeline.height + ")")
    .call(globals.timeline.xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", $(window).width() / 2)
      .attr("y", -20)
      .style("text-anchor", "middle")
      .style("font-size", '16px')
      
      .text("Years Before Present");
   
   globals.timeline.svg.selectAll(".point")
   	.data(data)
   	.enter()
   	.append('circle')
   		.attr('class', function(d) { return "point timeline-point " + removeNonLetters(d.siteName) + "_" + d.age})
   		.attr('cy', 30)
   		.attr('cx', function(d){return globals.timeline.x(d.age)})
   		.attr('r', 5)
   		.attr('fill', 'blue')
   		.on('mouseover', function(d){
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	highlight(c)
      }).on('mouseout', function(d){
      	c = "." + removeNonLetters(d.siteName) + "_" + d.age
      	deHighlight(c)
      });
}
function highlight(className, r){
	_r = 7
	console.log(className)
	d3.selectAll(className).transition()
		.attr('fill', 'orange')
		.attr('stroke', 'black')
		.attr('r', _r*2)
		.style('opacity', 0.75)
	d3.selectAll(className).moveToFront();
}
function deHighlight(className){
	_r = $("#point-radius").val();
	d3.selectAll(className).transition()
		.attr('fill', 'blue')
		.attr('stroke', 'none')
		.attr('r', _r)
		.attr('opacity', 1)
}

function stylePointsByAgeBounds(age, bandWidth){
	d3.selectAll(".point")
		.attr('fill', function(d){
			if ((d.age < (age + bandWidth)) && (d.age > (age - bandWidth))){
				return 'red';
			}else{
				return 'blue';
			}
		});
}

function stylePointsByAgeRange(minAge, maxAge){
	d3.selectAll(".point")
		.attr('fill', function(d){
			if ((d.age <= maxAge) && (d.age >= minAge)){
				return 'red';
			}else{
				return 'blue';
			}
		});
}



function changePointRadius(radius){
	console.log("Changing to: " + radius)
	d3.selectAll(".point")
		.attr('r', radius);
}
function changeHexRadius(radius){
	drawChartHexes(globals.chart.xVar, globals.chart.yVar, globals.data, radius);
}
$("#point-radius").change(function(){
	changePointRadius($(this).val());
})
$("#hex-radius").change(function(){
	changeHexRadius($(this).val());
})
$("#min-year").change(function(){
	refMinAge = $("#min-year").val();
	refMaxAge = $("#max-year").val();
	stylePointsByAgeRange(refMinAge, refMaxAge);
})
$("#max-year").change(function(){
	refMinAge = $("#min-year").val();
	refMaxAge = $("#max-year").val();
	stylePointsByAgeRange(refMinAge, refMaxAge);
})
function removeNonLetters(str){
	str = str.replace(/[^a-zA-Z ]/g, "");
	str = str.replace(" ", "");
	return str;
}

</script>
		
	</body>
</html>